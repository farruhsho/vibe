# Улучшения системы рекомендаций Vibe

## Обзор

Система рекомендаций Vibe была полностью переработана для обеспечения более точных и персонализированных рекомендаций музыки, превосходящих аналоги (Яндекс Музыка, Spotify).

## Ключевые улучшения

### 1. Адаптивное взвешивание параметров

**Было:**
- Фиксированные веса для всех пользователей
- 4 параметра: energy (30%), valence (30%), danceability (25%), tempo (15%)

**Стало:**
- Динамические веса на основе силы предпочтений пользователя
- 6 параметров: energy, valence, danceability, tempo, acousticness, mood (key+mode)
- Веса адаптируются к силе паттерна пользователя (patternStrength)

```dart
final double energyWeight = 0.25 + (patternStrength * 0.05);
final double valenceWeight = 0.25 + (patternStrength * 0.05);
```

### 2. Контекстная персонализация

**Время суток:**
- Утро (6:00-10:00): предпочтение энергичной музыке
- День (10:00-18:00): сбалансированный подход
- Вечер (18:00-22:00): приятная, но не слишком интенсивная музыка
- Ночь (22:00-6:00): спокойная, расслабляющая музыка

**Реализация:**
```dart
static double _getTimeOfDayBoost(DateTime time, UserPattern userPattern) {
  final hour = time.hour;
  if (hour >= 6 && hour < 10) {
    return userPattern.avgEnergy > 0.6 ? 0.2 : 0.0;
  }
  // ... и т.д.
}
```

### 3. Музыкальная теория - анализ тональности

Новый параметр `moodScore` учитывает гармонию между:
- **Key** (тональность): C, C#, D и т.д.
- **Mode** (лад): мажор (1) или минор (0)
- **Valence** (настроение трека)

**Логика:**
- Мажорный лад + высокий valence = идеальное совпадение (1.0)
- Минорный лад + низкий valence = идеальное совпадение (1.0)
- Несовпадение = более низкий балл

### 4. Умное разнообразие треков

**Было:**
- Простая проверка похожести со всеми выбранными треками
- Фиксированный порог похожести (0.7)

**Стало:**
- Трехуровневая система (top/mid/lower tiers по score)
- Sliding window подход (проверка только последних 5 треков)
- Распределение: 60% top-tier, 30% mid-tier, 10% lower-tier
- Адаптивный порог похожести (0.65)

### 5. Избежание повторений

**Новая функция:**
- Получение последних 10 прослушанных треков
- 50% штраф для недавно прослушанных треков
- Автоматическое обновление при каждом воспроизведении

### 6. Анализ временных паттернов

**PatternAnalyzer теперь собирает:**
- Предпочтения по 6 временным периодам (0-4h, 4-8h, 8-12h, 12-16h, 16-20h, 20-24h)
- Сохранение в `timeOfDayPreferences` в UserPattern
- Автоматическое применение при формировании рекомендаций

### 7. Расширенные аудио-характеристики

**Добавлены параметры:**
- `acousticness` - акустичность vs электронная музыка
- `instrumentalness` - инструментальность vs вокал
- `key` - музыкальная тональность (0-11)
- `mode` - мажор/минор (0/1)

### 8. Увеличенный пул треков

- Для каждого настроения теперь 5+ разнообразных треков
- Все треки имеют полные audio features
- Более широкий диапазон параметров для лучшего тестирования

## Технические детали

### Файлы изменены:

1. **lib/services/recommendation_algorithm.dart**
   - Добавлены новые методы расчёта
   - Контекстное взвешивание
   - Улучшенная система разнообразия

2. **lib/services/pattern_analyzer.dart**
   - Сбор временных паттернов
   - Анализ предпочтений по времени суток
   - Метод `_analyzeTimeOfDayPatterns()`

3. **lib/services/spotify_service.dart**
   - Интеграция нового алгоритма в `getAIRecommendations()`
   - Получение недавних треков для избежания повторений
   - Расширенные mock-треки с полными аудио-характеристиками

4. **lib/models/audio_features.dart**
   - Поддержка всех новых параметров

5. **lib/models/user_pattern.dart**
   - Поле `timeOfDayPreferences` для временных паттернов

## Преимущества перед конкурентами

### Vs Яндекс Музыка:

1. **Более глубокая персонализация** - учёт силы предпочтений пользователя
2. **Контекстная осведомлённость** - музыка адаптируется к времени суток
3. **Музыкальная теория** - использование тональности и лада
4. **Прозрачность** - пользователь видит score и может влиять через рейтинги

### Vs Spotify:

1. **Адаптивные веса** - алгоритм подстраивается под каждого пользователя
2. **Умное разнообразие** - баланс между релевантностью и новизной
3. **Избежание повторений** - автоматическое отслеживание недавних треков
4. **Временные паттерны** - музыка меняется в зависимости от времени дня

## Метрики качества

Система отслеживает:
- Средний рейтинг рекомендаций
- Точность предсказаний (predicted score vs user rating)
- Силу паттерна пользователя (pattern strength)
- Количество проанализированных треков

## Будущие улучшения

1. **Machine Learning**
   - Обучение на реальных данных пользователей
   - Collaborative filtering для похожих пользователей

2. **Контекстные данные**
   - Активность (бег, работа, отдых)
   - Погода
   - Геолокация

3. **Социальные функции**
   - Рекомендации от друзей
   - Популярное в вашем регионе

4. **Анализ текстов**
   - Lyrics analysis для более точного определения настроения
   - Genre detection

## Заключение

Новая система рекомендаций Vibe представляет собой значительное улучшение по сравнению с базовой версией и конкурентами. Она сочетает:
- Математическую точность (Gaussian distribution, z-scores)
- Музыкальную теорию (key, mode, harmony)
- Контекстную осведомлённость (время, история)
- Адаптивность (learning from user behavior)

Результат - более персонализированный, разнообразный и приятный опыт прослушивания музыки.
